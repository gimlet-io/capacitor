apiVersion: v1
kind: Secret
metadata:
  name: {{ include "capacitor-server.fullname" . }}
  namespace: {{ .Release.Namespace }}
  labels:
    {{- include "capacitor-server.labels" . | nindent 4 }}
type: Opaque
stringData:
  {{- if .Values.licenseKey }}
  LICENSE_KEY: {{ .Values.licenseKey | quote }}
  {{- end }}
  {{- if .Values.auth }}
  {{- if .Values.auth.method }}
  AUTH: {{ .Values.auth.method | quote }}
  {{- end }}
  {{- if eq .Values.auth.method "oidc" }}
  {{- if .Values.auth.oidc.issuer }}
  OIDC_ISSUER: {{ .Values.auth.oidc.issuer | quote }}
  {{- end }}
  {{- if .Values.auth.oidc.clientId }}
  OIDC_CLIENT_ID: {{ .Values.auth.oidc.clientId | quote }}
  {{- end }}
  {{- if .Values.auth.oidc.clientSecret }}
  OIDC_CLIENT_SECRET: {{ .Values.auth.oidc.clientSecret | quote }}
  {{- end }}
  {{- if .Values.auth.oidc.redirectUrl }}
  OIDC_REDIRECT_URL: {{ .Values.auth.oidc.redirectUrl | quote }}
  {{- end }}
  {{- if .Values.auth.oidc.insecureSkipTlsVerify }}
  OIDC_INSECURE_SKIP_TLS_VERIFY: "true"
  {{- end }}
  {{- if .Values.auth.oidc.scopes }}
  OIDC_SCOPES: {{ .Values.auth.oidc.scopes | quote }}
  {{- end }}
  {{- if .Values.auth.oidc.groupsClaim }}
  OIDC_GROUPS_CLAIM: {{ .Values.auth.oidc.groupsClaim | quote }}
  {{- end }}
  {{- if .Values.auth.oidc.authorizedEmails }}
  AUTHORIZED_EMAILS: {{ .Values.auth.oidc.authorizedEmails | quote }}
  {{- end }}
  {{- if .Values.auth.oidc.entraIdFederatedTokenAuth }}
  ENTRA_ID_FEDEREATED_TOKEN_AUTH: "true"
  {{- end }}
  {{- else if eq .Values.auth.method "static" }}
  {{- if .Values.auth.static }}
  {{- if .Values.auth.static.users }}
  USERS: {{ .Values.auth.static.users | quote }}
  {{- end }}
  {{- end }}
  {{- end }}
  {{- if .Values.auth.debug }}
  OIDC_DEBUG: "true"
  {{- end }}
  {{- end }}
  {{- if .Values.authorization }}
  {{- if .Values.authorization.impersonateSaRules }}
  IMPERSONATE_SA_RULES: {{ .Values.authorization.impersonateSaRules | quote }}
  {{- end }}
  {{- end }}
  {{- if .Values.session }}
  {{- if .Values.session.hashKey }}
  SESSION_HASH_KEY: {{ .Values.session.hashKey | quote }}
  {{- end }}
  {{- if .Values.session.blockKey }}
  SESSION_BLOCK_KEY: {{ .Values.session.blockKey | quote }}
  {{- end }}
  {{- end }}
  {{- if .Values.systemViews }}
  SYSTEM_VIEWS: {{ .Values.systemViews | quote }}
  {{- end }}
  registry.yaml: |
    clusters:
    {{- range .Values.clusters }}
      - id: {{ .id }}
        name: {{ .name }}
        {{- if .agent }}
        agent: true
        agentSecret: {{ .agentSecret | quote }}
        {{- else }}
        apiServerURL: {{ .apiServerURL }}
        {{- if .certificateAuthorityFile }}
        certificateAuthorityFile: {{ .certificateAuthorityFile }}
        {{- end }}
        {{- if .serviceAccount }}
        serviceAccount:
          {{- if .serviceAccount.tokenFile }}
          tokenFile: {{ .serviceAccount.tokenFile }}
          {{- end }}
        {{- end }}
        {{- end }}
    {{- end }}
