---
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRole
metadata:
  name: {{ include "capacitor-agent.fullname" . }}-impersonator
  labels:
    {{- include "capacitor-agent.labels" . | nindent 4 }}
rules:
  - apiGroups: [""]
    resources: ["users", "groups", "serviceaccounts"]
    verbs: ["impersonate"]
---
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRoleBinding
metadata:
  name: {{ include "capacitor-agent.fullname" . }}-impersonator-binding
  labels:
    {{- include "capacitor-agent.labels" . | nindent 4 }}
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: ClusterRole
  name: {{ include "capacitor-agent.fullname" . }}-impersonator
subjects:
  - kind: ServiceAccount
    name: {{ include "capacitor-agent.serviceAccountName" . }}
    namespace: {{ .Release.Namespace }}
{{- if .Values.permissionElevation.workloadRestart }}
---
# Permission Elevation: Workload Restart
# Allows the agent service account to delete pods and patch workloads
# for rollout restart operations, bypassing user impersonation.
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRole
metadata:
  name: {{ include "capacitor-agent.fullname" . }}-elevation-workload-restart
  labels:
    {{- include "capacitor-agent.labels" . | nindent 4 }}
rules:
  # Pod deletion for restarting pods
  - apiGroups: [""]
    resources: ["pods"]
    verbs: ["delete"]
  # Deployment/StatefulSet/DaemonSet patch for rollout restart
  - apiGroups: ["apps"]
    resources: ["deployments", "statefulsets", "daemonsets"]
    verbs: ["patch"]
---
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRoleBinding
metadata:
  name: {{ include "capacitor-agent.fullname" . }}-elevation-workload-restart-binding
  labels:
    {{- include "capacitor-agent.labels" . | nindent 4 }}
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: ClusterRole
  name: {{ include "capacitor-agent.fullname" . }}-elevation-workload-restart
subjects:
  - kind: ServiceAccount
    name: {{ include "capacitor-agent.serviceAccountName" . }}
    namespace: {{ .Release.Namespace }}
{{- end }}
{{- if .Values.permissionElevation.fluxReconciliation }}
---
# Permission Elevation: Flux Reconciliation
# Allows the agent service account to patch Flux resources
# for triggering reconciliation, bypassing user impersonation.
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRole
metadata:
  name: {{ include "capacitor-agent.fullname" . }}-elevation-flux-reconciliation
  labels:
    {{- include "capacitor-agent.labels" . | nindent 4 }}
rules:
  # Kustomizations
  - apiGroups: ["kustomize.toolkit.fluxcd.io"]
    resources: ["kustomizations"]
    verbs: ["patch"]
  # HelmReleases
  - apiGroups: ["helm.toolkit.fluxcd.io"]
    resources: ["helmreleases"]
    verbs: ["patch"]
  # Sources (GitRepository, HelmRepository, HelmChart, OCIRepository, Bucket)
  - apiGroups: ["source.toolkit.fluxcd.io"]
    resources: ["gitrepositories", "helmrepositories", "helmcharts", "ocirepositories", "buckets"]
    verbs: ["patch"]
  # Terraform (if using tf-controller)
  - apiGroups: ["infra.contrib.fluxcd.io"]
    resources: ["terraforms"]
    verbs: ["patch"]
---
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRoleBinding
metadata:
  name: {{ include "capacitor-agent.fullname" . }}-elevation-flux-reconciliation-binding
  labels:
    {{- include "capacitor-agent.labels" . | nindent 4 }}
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: ClusterRole
  name: {{ include "capacitor-agent.fullname" . }}-elevation-flux-reconciliation
subjects:
  - kind: ServiceAccount
    name: {{ include "capacitor-agent.serviceAccountName" . }}
    namespace: {{ .Release.Namespace }}
{{- end }}
{{- if .Values.permissionElevation.helmInfo }}
---
# Permission Elevation: Helm Info
# Allows the agent service account to read Helm release secrets
# for displaying release history, values, and manifests, bypassing user impersonation.
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRole
metadata:
  name: {{ include "capacitor-agent.fullname" . }}-elevation-helm-info
  labels:
    {{- include "capacitor-agent.labels" . | nindent 4 }}
rules:
  # Read Helm release secrets (sh.helm.release.v1.*)
  - apiGroups: [""]
    resources: ["secrets"]
    verbs: ["get", "list"]
---
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRoleBinding
metadata:
  name: {{ include "capacitor-agent.fullname" . }}-elevation-helm-info-binding
  labels:
    {{- include "capacitor-agent.labels" . | nindent 4 }}
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: ClusterRole
  name: {{ include "capacitor-agent.fullname" . }}-elevation-helm-info
subjects:
  - kind: ServiceAccount
    name: {{ include "capacitor-agent.serviceAccountName" . }}
    namespace: {{ .Release.Namespace }}
{{- end }}
